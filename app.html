<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>

<body>
<script type="text/javascript">
    if (typeof FeifanWallet !== 'object') {
        FeifanWallet = {};
    }

    (function() {
        var ua = navigator.userAgent.toLowerCase(),
            locked = false,
            domLoaded = document.readyState === 'complete',
            delayToRun;

        function customClickEvent() {
            var clickEvt;
            if (window.CustomEvent) {
                clickEvt = new window.CustomEvent('click', {
                    canBubble: true,
                    cancelable: true
                });
            } else {
                clickEvt = document.createEvent('Event');
                clickEvt.initEvent('click', true, true);
            }
            console.log(clickEvt);
            return clickEvt;
        }

        function getAndroidVersion() {
            var match = ua.match(/android\s([0-9\.]*)/);
            return match ? match[1] : false;
        }

        var noIntentTest = /360 aphone|weibo|windvane|ucbrowser|baidubrowser/.test(ua);
        var hasIntentTest = /chrome|samsung/.test(ua);
        var isAndroid = /android|adr/.test(ua) && !(/windows phone/.test(ua));
        var canIntent = !noIntentTest && hasIntentTest && isAndroid;
        var openInIfr = /weibo|m353/.test(ua);
        var inWeibo = ua.indexOf('weibo') > -1;

        if (ua.indexOf('m353') > -1 && !noIntentTest) {
            canIntent = false;
        }

        // 是否在 webview
        var inWebview = '';
        if (inWebview) {
            canIntent = false;
        }


        /**
         * 打开app
         * @param   {string}    params  唤起app的参数设置
         * @param   {boolean}   jumpUrl 唤起app后，android下要跳转到的URL；
         *                      若传"default"，则为http://a.app.qq.com/o/simple.jsp?pkgname=com.wanda.app.wanhui
         */
        FeifanWallet.open = function(params, jumpUrl) {
            if (!domLoaded && (ua.indexOf('360 aphone') > -1 || canIntent)) {
                var arg = arguments;
                delayToRun = function() {
                    FeifanWallet.open.apply(null, arg);
                    delayToRun = null;
                };
                return;
            }

            // 唤起锁定，避免重复唤起
            if (locked) {
                return;
            }
            locked = true;

            var o;
            // 参数容错
            if (typeof params === 'object') {
                o = params;
            } else {
                o = {
                    params: params,
                    jumpUrl: jumpUrl
                };
            }

            // 参数容错
            if (typeof o.params !== 'string') {
                o.params = '';
            }

            if (o.params.indexOf('startapp?') > -1) {
                o.params = o.params.split('startapp?')[1];
            } else if (o.params.indexOf('startApp?') > -1) {
                o.params = o.params.split('startApp?')[1];
            }


            // 通过wandaappfeifan协议唤起钱包
            var schemePrefix = "wandaappfeifan";
            // if (ua.indexOf('mac os') > -1 && ua.indexOf('mobile') > -1) {

            // }
            // schemePrefix = schemePrefix || 'wandaappfeifan';


            if (!canIntent) {
                // var feifanUrl = schemePrefix + '://h2/app?' + o.params;
                var feifanUrl = schemePrefix + '://';

                console.log(ua.indexOf('qq/') > -1 || (ua.indexOf('safari') > -1 && ua.indexOf('os 9_') > -1));

                if (ua.indexOf('qq/') > -1 || (ua.indexOf('safari') > -1 && ua.indexOf('os 9_') > -1)) {
                    var openSchemeLink = document.getElementById('openSchemeLink');
                    if (!openSchemeLink) {
                        openSchemeLink = document.createElement('a');
                        openSchemeLink.id = 'openSchemeLink';
                        openSchemeLink.style.display = 'none';
                        document.body.appendChild(openSchemeLink);
                        console.log(111);
                    }
                    openSchemeLink.href = feifanUrl;
                    // 执行click
                    openSchemeLink.dispatchEvent(customClickEvent());
                } else {
                    var ifr = document.createElement('iframe');
                    ifr.src = feifanUrl;
                    ifr.style.display = 'none';
                    document.body.appendChild(ifr);
                }
            } else {
                // android 下 chrome 浏览器通过 intent 协议唤起钱包
                var packageKey = 'com.wanda.app.wanhui';

                var intentUrl = 'intent://m.ffan.com/app.html?' + o.params + '#Intent;scheme=' + schemePrefix + ';package=' + packageKey + ';S.browser_fallback_url＝http://a.app.qq.com/o/simple.jsp?pkgname=com.wanda.app.wanhui;end';

                var openIntentLink = document.getElementById('openIntentLink');
                if (!openIntentLink) {
                    openIntentLink = document.createElement('a');
                    openIntentLink.id = 'openIntentLink';
                    openIntentLink.style.display = 'none';
                    document.body.appendChild(openIntentLink);
                }
                openIntentLink.href = intentUrl;
                // 执行click
                openIntentLink.dispatchEvent(customClickEvent());
            }

            // 延迟移除用来唤起钱包的IFRAME并跳转到下载页
            setTimeout(function() {
                if (typeof o.jumpUrl !== 'string') {
                    o.jumpUrl = '';
                }

                // 默认跳转地址
                if (o.jumpUrl === 'default') {
                    o.jumpUrl = 'http://a.app.qq.com/o/simple.jsp?pkgname=com.wanda.app.wanhui';
                }

                if (o.jumpUrl && typeof o.jumpUrl === 'string') {
                    location.href = o.jumpUrl;
                }
            }, 1000)


            // 唤起加锁，避免短时间内被重复唤起
            setTimeout(function() {
                locked = false;
            }, 2500)
        }

        if (!domLoaded) {
            document.addEventListener('DOMContentLoaded', function() {
                domLoaded = true;
                if (typeof delayToRun === 'function') {
                    delayToRun();
                }
            }, false);
        }
    })();
    FeifanWallet.open({
        params: "",
        jumpUrl: ''
    });
    </script>
    <div class="main">
        <div class="title" id="title">
            <a class="download-btn" id="openIntentLink" href="">下载飞凡客户端</a>
        </div>
    </div>
</body>

</html>
